<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogiGo Library: Sorting Algorithms</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            margin-top: 0;
            color: #2c3e50;
        }

        .controls {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            gap: 10px;
        }

        button {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        button:hover {
            background: #2980b9;
        }

        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        /* Visualization Area */
        .visualizer {
            height: 300px;
            background: #ecf0f1;
            border-radius: 8px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding: 20px;
            gap: 4px;
            margin-bottom: 20px;
        }

        .bar {
            width: 30px;
            background: #3498db;
            border-radius: 4px 4px 0 0;
            transition: height 0.2s, background 0.2s;
            position: relative;
        }

        .bar-label {
            position: absolute;
            bottom: -25px;
            width: 100%;
            text-align: center;
            font-size: 12px;
            color: #7f8c8d;
        }

        /* Stats Panel */
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>ðŸ“š Library of Logic: Sorting</h1>
        <p>Standard algorithms instrumented with LogiGo for visual debugging and AI verification.</p>

        <div class="controls">
            <button onclick="resetArray()">ðŸŽ² Randomize Array</button>
            <div style="width: 20px;"></div>
            <button onclick="runBubbleSort()">Run Bubble Sort</button>
            <button onclick="runQuickSort()">Run Quick Sort</button>
            <button onclick="runMergeSort()">Run Merge Sort</button>
        </div>

        <div id="algo-description"
            style="background: #e8f6f3; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2ecc71; display: none;">
            <h3 style="margin-top:0; color: #27ae60;" id="algo-title">Algorithm</h3>
            <p id="algo-text" style="margin-bottom:0; color: #555;"></p>
        </div>

        <div class="visualizer" id="array-container">
            <!-- Bars will be injected here -->
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="stat-comparisons">0</div>
                <div class="stat-label">Comparisons</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-swaps">0</div>
                <div class="stat-label">Swaps</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-checkpoints">0</div>
                <div class="stat-label">Checkpoints</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-time">0ms</div>
                <div class="stat-label">Time</div>
            </div>
        </div>
    </div>

    <script type="module">
        import LogiGoOverlay from '../../src/overlay.js';

        // Initialize LogiGo
        const logigo = new LogiGoOverlay({
            speed: 2.0, // Faster default speed for sorting
            position: 'bottom-right'
        }).init();
        window.LogiGo = logigo;

        // State
        let array = [];
        const ARRAY_SIZE = 20;
        let stats = { comparisons: 0, swaps: 0, checkpoints: 0, startTime: 0 };

        // --- Helper Functions ---

        function showDescription(title, text) {
            const box = document.getElementById('algo-description');
            document.getElementById('algo-title').textContent = title;
            document.getElementById('algo-text').textContent = text;
            box.style.display = 'block';
        }

        function generateArray() {
            array = [];
            for (let i = 0; i < ARRAY_SIZE; i++) {
                array.push(Math.floor(Math.random() * 90) + 10);
            }
            renderArray();
            resetStats();
        }

        function renderArray() {
            const container = document.getElementById('array-container');
            container.innerHTML = '';
            array.forEach((value, index) => {
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.id = `bar-${index}`;
                bar.style.height = `${value * 3}px`;

                const label = document.createElement('div');
                label.className = 'bar-label';
                label.textContent = value;
                bar.appendChild(label);

                container.appendChild(bar);
            });
        }

        function resetStats() {
            stats = { comparisons: 0, swaps: 0, checkpoints: 0, startTime: Date.now() };
            updateStatsUI();
        }

        function updateStatsUI() {
            document.getElementById('stat-comparisons').textContent = stats.comparisons;
            document.getElementById('stat-swaps').textContent = stats.swaps;
            document.getElementById('stat-checkpoints').textContent = stats.checkpoints;
            document.getElementById('stat-time').textContent = (Date.now() - stats.startTime) + 'ms';
        }

        async function swap(i, j) {
            stats.swaps++;

            // Visual Handshake: Highlight bars being swapped
            await LogiGo.checkpoint(`swap:${i}:${j}`, {
                domElement: `#bar-${i}`, // Highlight first bar
                variables: { i, j, val_i: array[i], val_j: array[j] },
                color: '#e74c3c' // Red for swap
            });

            // Also highlight the second bar manually for visual effect
            const barJ = document.getElementById(`bar-${j}`);
            if (barJ) {
                barJ.style.boxShadow = '0 0 10px 2px #e74c3c';
                setTimeout(() => barJ.style.boxShadow = '', 500);
            }

            const temp = array[i];
            array[i] = array[j];
            array[j] = temp;

            renderArray();
            updateStatsUI();
        }

        // --- Algorithms ---

        // 1. Bubble Sort
        window.runBubbleSort = async () => {
            generateArray(); // Auto-reset
            showDescription("Bubble Sort", "Repeatedly steps through the list, compares adjacent elements and swaps them if they are in the wrong order. Simple but inefficient (O(nÂ²)).");

            await LogiGo.checkpoint('bubble_sort:start', { variables: { array } });

            for (let i = 0; i < array.length; i++) {
                for (let j = 0; j < array.length - i - 1; j++) {
                    stats.comparisons++;

                    // Checkpoint: Comparison
                    await LogiGo.checkpoint(`compare:${j}:${j + 1}`, {
                        domElement: `#bar-${j}`,
                        color: '#f1c40f', // Yellow for compare
                        variables: { left: array[j], right: array[j + 1] }
                    });

                    if (array[j] > array[j + 1]) {
                        await swap(j, j + 1);
                    }
                }
            }

            await LogiGo.checkpoint('bubble_sort:complete', { color: '#2ecc71' });
        };

        // 2. Quick Sort
        window.runQuickSort = async () => {
            generateArray(); // Auto-reset
            showDescription("Quick Sort", "A divide-and-conquer algorithm. It picks a 'pivot' element and partitions the array so smaller elements are on the left and larger on the right. Very efficient (O(n log n)).");

            await LogiGo.checkpoint('quick_sort:start');
            await quickSort(0, array.length - 1);
            await LogiGo.checkpoint('quick_sort:complete', { color: '#2ecc71' });
        };

        async function quickSort(low, high) {
            if (low < high) {
                // Hierarchical Checkpoint: Partition Start
                await LogiGo.checkpoint(`quick_sort:partition_start:${low}:${high}`);

                let pi = await partition(low, high);

                await quickSort(low, pi - 1);
                await quickSort(pi + 1, high);
            }
        }

        async function partition(low, high) {
            let pivot = array[high];

            // Highlight Pivot
            await LogiGo.checkpoint(`partition:pivot_selected`, {
                domElement: `#bar-${high}`,
                color: '#9b59b6', // Purple for pivot
                variables: { pivot }
            });

            let i = (low - 1);

            for (let j = low; j < high; j++) {
                stats.comparisons++;

                await LogiGo.checkpoint(`partition:compare:${j}`, {
                    domElement: `#bar-${j}`,
                    color: '#f1c40f',
                    variables: { current: array[j], pivot }
                });

                if (array[j] < pivot) {
                    i++;
                    await swap(i, j);
                }
            }
            await swap(i + 1, high);
            return (i + 1);
        }

        // 3. Merge Sort
        window.runMergeSort = async () => {
            generateArray(); // Auto-reset
            showDescription("Merge Sort", "Divides the array into halves, sorts them recursively, and then merges the sorted halves. Stable and efficient (O(n log n)).");

            await LogiGo.checkpoint('merge_sort:start');
            await mergeSort(0, array.length - 1);
            await LogiGo.checkpoint('merge_sort:complete', { color: '#2ecc71' });
        };

        async function mergeSort(l, r) {
            if (l >= r) return;

            const m = l + parseInt((r - l) / 2);

            await LogiGo.checkpoint(`merge_sort:split:${l}:${r}`, {
                variables: { left: l, mid: m, right: r }
            });

            await mergeSort(l, m);
            await mergeSort(m + 1, r);
            await merge(l, m, r);
        }

        async function merge(l, m, r) {
            await LogiGo.checkpoint(`merge_sort:merge_start:${l}:${r}`, {
                color: '#3498db' // Blue for merge
            });

            const n1 = m - l + 1;
            const n2 = r - m;
            const L = new Array(n1);
            const R = new Array(n2);

            for (let i = 0; i < n1; i++) L[i] = array[l + i];
            for (let j = 0; j < n2; j++) R[j] = array[m + 1 + j];

            let i = 0, j = 0, k = l;

            while (i < n1 && j < n2) {
                stats.comparisons++;
                if (L[i] <= R[j]) {
                    array[k] = L[i];
                    i++;
                } else {
                    array[k] = R[j];
                    j++;
                }
                // Visual update for merge step
                renderArray();
                await LogiGo.checkpoint(`merge:place:${k}`, {
                    domElement: `#bar-${k}`,
                    color: '#2ecc71'
                });
                k++;
            }

            while (i < n1) {
                array[k] = L[i];
                renderArray();
                await LogiGo.checkpoint(`merge:place_remaining_left:${k}`);
                i++; k++;
            }

            while (j < n2) {
                array[k] = R[j];
                renderArray();
                await LogiGo.checkpoint(`merge:place_remaining_right:${k}`);
                j++; k++;
            }
        }

        // Init
        window.resetArray = generateArray;
        generateArray();

    </script>

</body>

</html>